"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start –∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
"""
from aiogram import Router, F
from aiogram.types import Message
from aiogram.filters import Command
from database import add_user, get_program
from utils.keyboards import get_main_keyboard, get_save_program_keyboard
from parser import parse_program, get_current_day
import database

router = Router()


@router.message(Command("start"))
async def cmd_start(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.
    –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
    """
    user_id = message.from_user.id
    username = message.from_user.username
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
    add_user(user_id, username)
    
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –∏ —Ä–∞–±–æ—á–∏—Ö –≤–µ—Å–æ–≤.\n\n"
        "üìù –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–≤–æ—é –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n\n"
        "1Ô∏è‚É£ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π:\n"
        "–ü–ù: –∂–∏–º –ª—ë–∂–∞ 3x10, –ø—Ä–∏—Å–µ–¥ 4x8; –í–¢: –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 3x–º–∞–∫—Å\n\n"
        "2Ô∏è‚É£ –° —Ç–∏—Ä–µ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π):\n"
        "üîπ –ü–¢ –ù–æ–≥–∏\n"
        "–ì–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Äî 4—Ö10\n"
        "–ñ–∏–º –Ω–æ–≥ ‚Äî 3—Ö12\n\n"
        "3Ô∏è‚É£ –° –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏:\n"
        "–ü–¢ –ù–æ–≥–∏\n"
        "–ì–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Äî 20-16-14-12\n"
        "–ñ–∏–º –Ω–æ–≥ ‚Äî 18-10-14\n\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.",
        reply_markup=get_main_keyboard()
    )


@router.message(F.text == "–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É")
async def start_training_button(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É".
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –º–æ–¥—É–ª—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.
    """
    user_id = message.from_user.id
    current_day = get_current_day()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
    program = get_program(user_id, current_day)
    
    if not program or current_day not in program:
        await message.answer(
            f"‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è ({current_day}).\n\n"
            "üìù –û—Ç–ø—Ä–∞–≤—å –ø—Ä–æ–≥—Ä–∞–º–º—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:\n\n"
            "üîπ –ü–¢ –ù–æ–≥–∏\n"
            "–ì–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Äî 4—Ö10\n"
            "–ñ–∏–º –Ω–æ–≥ ‚Äî 3—Ö12"
        )
        return
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    from handlers.training import start_training_session
    await start_training_session(message, current_day)


@router.message(F.text == "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
async def stats_button(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞".
    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –º–æ–¥—É–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
    """
    from handlers.stats import cmd_stats
    await cmd_stats(message)


@router.message(F.text & ~F.text.in_(["–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É", "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"]))
async def handle_program_text(message: Message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.
    –ü–∞—Ä—Å–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ—ë.
    –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –∏ –∫–Ω–æ–ø–∫–∏.
    """
    user_id = message.from_user.id
    text = message.text.strip()
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞
    if text.startswith('/'):
        return
    
    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É
    try:
        program = parse_program(text)
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        from utils.helpers import format_program_text
        program_text = format_program_text(program)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis –∏–ª–∏ FSM)
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å
        if not hasattr(database, 'temp_programs'):
            database.temp_programs = {}
        database.temp_programs[user_id] = program
        
        await message.answer(
            f"‚úÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞:\n{program_text}\n\n"
            "–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É.",
            reply_markup=get_save_program_keyboard()
        )
        
    except ValueError as e:
        await message.answer(
            f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã: {str(e)}\n\n"
            "üìù –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\n\n"
            "1Ô∏è‚É£ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π:\n"
            "–ü–ù: –∂–∏–º –ª—ë–∂–∞ 3x10, –ø—Ä–∏—Å–µ–¥ 4x8; –í–¢: –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 3x–º–∞–∫—Å\n\n"
            "2Ô∏è‚É£ –° —Ç–∏—Ä–µ (–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π):\n"
            "üîπ –ü–¢ –ù–æ–≥–∏\n"
            "–ì–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Äî 4—Ö10\n"
            "–ñ–∏–º –Ω–æ–≥ ‚Äî 3—Ö12\n\n"
            "3Ô∏è‚É£ –° –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π:\n"
            "–ü–¢ –ù–æ–≥–∏\n"
            "–ì–∞–∫–∫-–ø—Ä–∏—Å–µ–¥ ‚Äî 20-16-14-12\n"
            "–ñ–∏–º –Ω–æ–≥ ‚Äî 18-10-14"
        )

